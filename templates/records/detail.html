{% extends 'base.html' %}
{% block title %}Registro {{ record.nro|stringformat:'03d' }}{% endblock %}
{% block content %}
<style>
  .header-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }
  .upload-grid {
    display: grid;
    grid-template-columns: minmax(220px, 320px) minmax(280px, 1fr) auto;
    gap: 14px;
    align-items: start;
  }
  .upload-btn-wrap {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
  }
  .upload-btn-wrap .ghost-label {
    visibility: hidden;
    margin-bottom: 6px;
    font-weight: 600;
  }
  .upload-btn-wrap .btn {
    min-height: 38px;
  }
  .file-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .btn-sm {
    padding: 6px 10px;
    border-radius: 7px;
    font-size: 13px;
    font-weight: 600;
  }
  .path-cell code {
    display: inline-block;
    max-width: 540px;
    overflow-wrap: anywhere;
    white-space: normal;
  }
  @media (max-width: 980px) {
    .upload-grid {
      grid-template-columns: 1fr;
    }
    .upload-btn-wrap {
      align-items: stretch;
    }
  }
</style>

<div class="card">
  <h2>Registro {{ record.nro|stringformat:'03d' }}</h2>
  <p><strong>Estado:</strong> <span class="badge">{{ record.status }}</span></p>
  <p><strong>Título:</strong> {{ record.titulo|default:'-' }}</p>
  <p><strong>Carrera:</strong> {{ record.career.carrera_excel|default:'-' }}</p>
  <div class="header-actions">
    {% if can_edit %}
      <a class="btn btn-secondary" href="{% url 'registry:records_edit' record.id %}">Editar metadatos</a>
    {% endif %}
  </div>
</div>

<div class="card">
  <h3>Archivos</h3>
  {% if can_edit %}
  <form method="post" enctype="multipart/form-data" action="{% url 'registry:records_upload_file' record.id %}" class="upload-grid">
    {% csrf_token %}
    <div class="form-row">{{ upload_form.file_type.label_tag }}{{ upload_form.file_type }}</div>
    <div class="form-row">{{ upload_form.file.label_tag }}{{ upload_form.file }}</div>
    <div class="upload-btn-wrap">
      <label class="ghost-label">Acción</label>
      <button class="btn btn-primary" type="submit">Subir archivo</button>
    </div>
  </form>
  {% endif %}
  <table>
    <thead><tr><th>Tipo</th><th>Nombre</th><th>Tamaño</th><th>Ruta</th><th>Acciones</th></tr></thead>
    <tbody>
      {% for f in files %}
      <tr>
        <td>{{ f.file_type }}</td>
        <td>{{ f.original_name }}</td>
        <td>{{ f.size_bytes }}</td>
        <td class="path-cell"><code>{{ f.stored_path }}</code></td>
        <td>
          <div class="file-actions">
            <a class="btn btn-secondary btn-sm" href="{{ f.file.url }}" target="_blank">Abrir</a>
            {% if can_edit %}
              <form method="post" action="{% url 'registry:records_delete_file' record.id f.id %}" onsubmit="return confirm('¿Eliminar este archivo?');" style="margin:0;">
                {% csrf_token %}
                <button class="btn btn-danger btn-sm" type="submit">Eliminar</button>
              </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Sin archivos.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Acciones de flujo</h3>
  {% if can_edit and record.status == 'BORRADOR' %}
    <form method="post" action="{% url 'registry:records_submit' record.id %}" style="margin-bottom:8px;">{% csrf_token %}
      <button class="btn btn-success" type="submit">Enviar a auditoría</button>
    </form>
  {% endif %}
  {% if can_edit and record.status == 'OBSERVADO' %}
    <form method="post" action="{% url 'registry:records_resubmit' record.id %}" style="margin-bottom:8px;">{% csrf_token %}
      <button class="btn btn-success" type="submit">Reenviar a auditoría</button>
    </form>
  {% endif %}

  {% if can_audit and record.status == 'EN_AUDITORIA' %}
    <form method="post" action="{% url 'registry:records_observe' record.id %}" style="margin-bottom:8px;">
      {% csrf_token %}
      {{ comment_form.comment }}
      <button class="btn btn-warning" type="submit">Observar</button>
    </form>
    <form method="post" action="{% url 'registry:records_approve' record.id %}">
      {% csrf_token %}
      {{ comment_form.comment }}
      <button class="btn btn-success" type="submit">Aprobar</button>
    </form>
  {% endif %}
</div>

<div class="card">
  <h3>Historial de auditoría</h3>
  <table>
    <thead><tr><th>Fecha</th><th>Acción</th><th>Usuario</th><th>Comentario</th></tr></thead>
    <tbody>
      {% for e in events %}
      <tr><td>{{ e.created_at }}</td><td>{{ e.action }}</td><td>{{ e.user.username }}</td><td>{{ e.comment }}</td></tr>
      {% empty %}
      <tr><td colspan="4">Sin eventos.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
