{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  .dash-head { display:flex; gap:12px; align-items:baseline; justify-content: space-between; flex-wrap: wrap; margin-bottom: 14px; }
  .dash-head h2 { margin: 0; }
  .dash-sub { margin: 0; color: #64748b; font-size: 13px; }
  .kpi-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
  .kpi { grid-column: span 4; padding: 16px; border-radius: 14px; border: 1px solid #e2e8f0; background: linear-gradient(180deg, #ffffff, #fbfdff); position: relative; overflow: hidden; }
  .kpi:hover { transform: translateY(-1px); transition: transform .12s ease; }
  .kpi a { text-decoration:none; color: inherit; display:block; }
  .kpi .label { font-size: 12px; letter-spacing: .10em; text-transform: uppercase; color: #64748b; }
  .kpi .value { margin-top: 10px; font-size: 34px; font-weight: 900; color: #0f172a; }
  .kpi .hint { margin-top: 4px; font-size: 12px; color:#64748b; }
  .kpi::after { content:""; position:absolute; inset:auto -40px -40px auto; width:140px; height:140px; border-radius: 999px; opacity:.14; background: #2563eb; }
  .kpi.kpi-green::after { background: #059669; }
  .kpi.kpi-amber::after { background: #d97706; }
  .kpi.kpi-slate::after { background: #475569; }
  .kpi.kpi-indigo::after { background: #4f46e5; }
  .kpi.kpi-gray::after { background: #334155; }

  .dash-panels { display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items:start; }
  .panel-title { margin: 0 0 10px 0; font-size: 16px; color:#0f172a; }
  .quick { display:flex; gap:10px; flex-wrap: wrap; }
  .quick .btn { font-weight: 800; }
  .btn-sm { padding: 6px 10px; border-radius: 7px; font-size: 13px; font-weight: 800; }
  .dash-actions { display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:nowrap; }
  .dash-actions .btn { white-space: nowrap; }
  .mini-table th:last-child, .mini-table td:last-child { width: 260px; }

  .status-table td:last-child { width: 120px; text-align:right; font-weight: 800; }

  .mini-table th, .mini-table td { font-size: 13px; }
  .mini-table td { vertical-align: top; }
  .muted { color:#64748b; }
  .title-cut { display:block; max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  @media (max-width: 980px) {
    .kpi { grid-column: span 6; }
    .dash-panels { grid-template-columns: 1fr; }
  }
  @media (max-width: 560px) {
    .kpi { grid-column: span 12; }
    .dash-actions { flex-wrap: wrap; justify-content: flex-start; }
    .mini-table th:last-child, .mini-table td:last-child { width: auto; }
    .dash-actions .btn { width: 100%; text-align: center; }
  }
</style>

<div class="dash-head">
  <div>
    <h2 style="margin:0">Dashboard</h2>
    <p class="dash-sub">Estado general del registro y auditoría de tesis.</p>
  </div>
  <div class="quick">
    <a class="btn btn-primary" href="{% url 'registry:groups_list' %}">Sustentaciones</a>
    <a class="btn btn-secondary" href="{% url 'registry:records_list' %}">Ver registros</a>
    {% if request.user.role == 'auditor' %}
      <a class="btn btn-success" href="{% url 'saf:batches_list' %}">Lotes SAF</a>
    {% endif %}
  </div>
</div>

<div class="kpi-grid" style="margin-bottom:14px;">
  <div class="kpi kpi-indigo">
    <a href="{% url 'registry:records_list' %}">
      <div class="label">Total</div>
      <div class="value">{{ total_records }}</div>
      <div class="hint">Todos los registros</div>
    </a>
  </div>
  <div class="kpi kpi-amber">
    <a href="{% url 'registry:records_list' %}?status=EN_AUDITORIA">
      <div class="label">En auditoría</div>
      <div class="value">{{ pending_audit }}</div>
      <div class="hint">Pendientes de revisión</div>
    </a>
  </div>
  <div class="kpi kpi-green">
    <a href="{% url 'registry:records_list' %}?status=APROBADO">
      <div class="label">Aprobados</div>
      <div class="value">
        {% for r in status_rows %}{% if r.status == 'APROBADO' %}{{ r.count }}{% endif %}{% endfor %}
      </div>
      <div class="hint">Listos para lote SAF</div>
    </a>
  </div>
</div>

<div class="dash-panels">
  <div class="card">
    <h3 class="panel-title">Últimos registros</h3>
    {% if recent_records %}
      <table class="mini-table">
        <thead><tr><th>Nro</th><th>Título</th><th>Estado</th><th>Acción</th></tr></thead>
        <tbody>
          {% for rec in recent_records %}
            <tr>
              <td><strong>{{ rec.nro|stringformat:'03d' }}</strong></td>
              <td>
                <span class="title-cut">{{ rec.titulo|default:"(sin título)" }}</span>
                <div class="muted" style="font-size:12px;">{{ rec.career.carrera_excel|default:"(sin carrera)" }}</div>
              </td>
              <td><span class="status-badge" data-status="{{ rec.status }}">{{ rec.get_status_display|upper }}</span></td>
              <td>
                <div class="dash-actions">
                  <a class="btn btn-secondary btn-sm" href="{% url 'registry:records_detail' rec.id %}">Abrir</a>
                  {% if rec.dspace_url %}
                    <a class="btn btn-success btn-sm" href="{{ rec.dspace_url }}" target="_blank" rel="noopener">Ver publicación</a>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted">Aún no hay registros. Crea uno desde "Sustentaciones".</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 class="panel-title">Resumen por estado</h3>
    <table class="status-table">
      <thead><tr><th>Estado</th><th>Cantidad</th></tr></thead>
      <tbody>
        {% for row in status_rows %}
          <tr>
            <td><span class="status-badge" data-status="{{ row.status }}">{{ row.label|upper }}</span></td>
            <td>{{ row.count }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if request.user.role == 'auditor' %}
      <div style="height:12px;"></div>
      <h3 class="panel-title" style="margin-top:0;">Pendientes de auditoría</h3>
      {% if pending_records %}
        <table class="mini-table">
          <thead><tr><th>Nro</th><th>Titulo</th><th></th></tr></thead>
          <tbody>
            {% for rec in pending_records %}
              <tr>
                <td><strong>{{ rec.nro|stringformat:'03d' }}</strong></td>
                <td><span class="title-cut">{{ rec.titulo|default:"(sin titulo)" }}</span></td>
                <td style="text-align:right;"><a class="btn btn-secondary" href="{% url 'registry:records_detail' rec.id %}">Revisar</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">No hay registros en auditoría.</div>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}
