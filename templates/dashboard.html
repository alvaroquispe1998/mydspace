{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  .dash-head { display:flex; gap:12px; align-items:baseline; justify-content: space-between; flex-wrap: wrap; margin-bottom: 14px; }
  .dash-head h2 { margin: 0; }
  .dash-sub { margin: 0; color: #64748b; font-size: 13px; }
  .kpi-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
  .kpi { grid-column: span 4; padding: 16px; border-radius: 14px; border: 1px solid #e2e8f0; background: linear-gradient(180deg, #ffffff, #fbfdff); position: relative; overflow: hidden; }
  .kpi:hover { transform: translateY(-1px); transition: transform .12s ease; }
  .kpi a { text-decoration:none; color: inherit; display:block; }
  .kpi .label { font-size: 12px; letter-spacing: .10em; text-transform: uppercase; color: #64748b; }
  .kpi .value { margin-top: 10px; font-size: 34px; font-weight: 900; color: #0f172a; }
  .kpi .hint { margin-top: 4px; font-size: 12px; color:#64748b; }
  .kpi::after { content:""; position:absolute; inset:auto -40px -40px auto; width:140px; height:140px; border-radius: 999px; opacity:.14; background: #2563eb; }
  .kpi.kpi-green::after { background: #059669; }
  .kpi.kpi-amber::after { background: #d97706; }
  .kpi.kpi-indigo::after { background: #4f46e5; }

  .dash-panels { display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items:start; }
  .panel-title { margin: 0 0 10px 0; font-size: 16px; color:#0f172a; }
  .quick { display:flex; gap:10px; flex-wrap: wrap; }
  .quick .btn { font-weight: 800; }
  .btn-sm { padding: 6px 10px; border-radius: 7px; font-size: 13px; font-weight: 800; }

  .mini-table th:last-child, .mini-table td:last-child { width: 200px; }
  .status-table td:last-child { width: 120px; text-align:right; font-weight: 800; }

  .mini-table th, .mini-table td { font-size: 13px; }
  .mini-table td { vertical-align: top; }
  .muted { color:#64748b; }
  .title-cut { display:block; max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  @media (max-width: 980px) {
    .kpi { grid-column: span 6; }
    .dash-panels { grid-template-columns: 1fr; }
  }
  @media (max-width: 560px) {
    .kpi { grid-column: span 12; }
    .mini-table th:last-child, .mini-table td:last-child { width: auto; }
    .quick .btn { width: 100%; text-align: center; }
  }
</style>

<div class="dash-head">
  <div>
    <h2 style="margin:0">Dashboard</h2>
    <p class="dash-sub">Estado general de las sustentaciones (grupos) y flujo de auditoría.</p>
  </div>
  <div class="quick">
    <a class="btn btn-primary" href="{% url 'registry:groups_list' %}">Sustentaciones</a>
  </div>
</div>

<div class="kpi-grid" style="margin-bottom:14px;">
  <div class="kpi kpi-indigo">
    <a href="{% url 'registry:groups_list' %}">
      <div class="label">Total</div>
      <div class="value">{{ total_groups }}</div>
      <div class="hint">Todas las sustentaciones</div>
    </a>
  </div>
  <div class="kpi kpi-amber">
    <a href="{% url 'registry:groups_list' %}">
      <div class="label">En auditoría</div>
      <div class="value">{{ pending_audit_groups }}</div>
      <div class="hint">Sustentaciones en revisión</div>
    </a>
  </div>
  <div class="kpi kpi-green">
    <a href="{% url 'registry:groups_list' %}">
      <div class="label">Aprobadas</div>
      <div class="value">
        {% for r in status_rows %}{% if r.status == 'APROBADO' %}{{ r.count }}{% endif %}{% endfor %}
      </div>
      <div class="hint">Listas para generar SAF</div>
    </a>
  </div>
</div>

<div class="dash-panels">
  <div class="card">
    <h3 class="panel-title">Últimas sustentaciones</h3>
    {% if recent_groups %}
      <table class="mini-table">
        <thead><tr><th>Fecha</th><th>Grupo</th><th>Estado</th><th>Registros</th><th></th></tr></thead>
        <tbody>
          {% for g in recent_groups %}
            <tr>
              <td style="white-space:nowrap;"><strong>{{ g.date }}</strong></td>
              <td><span class="title-cut">{{ g.name }}</span></td>
              <td><span class="status-badge" data-status="{{ g.status }}">{{ g.get_status_display|upper }}</span></td>
              <td>{{ g.records_count }}</td>
              <td style="text-align:right;">
                <a class="btn btn-secondary btn-sm" href="{% url 'registry:groups_detail' g.id %}">Abrir</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted">Aún no hay sustentaciones. Crea una desde "Sustentaciones".</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 class="panel-title">Resumen por estado</h3>
    <table class="status-table">
      <thead><tr><th>Estado</th><th>Cantidad</th></tr></thead>
      <tbody>
        {% for row in status_rows %}
          <tr>
            <td><span class="status-badge" data-status="{{ row.status }}">{{ row.label|upper }}</span></td>
            <td>{{ row.count }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if request.user.is_auditor %}
      <div style="height:12px;"></div>
      <h3 class="panel-title" style="margin-top:0;">Pendientes de auditoría</h3>
      {% if pending_groups %}
        <table class="mini-table">
          <thead><tr><th>Fecha</th><th>Grupo</th><th>Pendientes</th><th></th></tr></thead>
          <tbody>
            {% for g in pending_groups %}
              <tr>
                <td style="white-space:nowrap;"><strong>{{ g.date }}</strong></td>
                <td><span class="title-cut">{{ g.name }}</span></td>
                <td>{{ g.pending_records }}</td>
                <td style="text-align:right;"><a class="btn btn-secondary" href="{% url 'registry:groups_detail' g.id %}">Abrir</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">No hay sustentaciones en auditoría.</div>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}
