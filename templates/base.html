{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}SAF Platform{% endblock %}</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Tahoma, sans-serif; margin:0; background:#f4f6f9; color:#1f2937; }
    .nav { background:#0f172a; color:#fff; padding:12px 20px; display:flex; gap:14px; align-items:center; }
    .nav a { color:#dbeafe; text-decoration:none; font-size:14px; }
    .nav .right { margin-left:auto; }
    .container { max-width:1200px; margin:20px auto; padding:0 16px; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:16px; }
    .btn { border:none; border-radius:8px; padding:8px 12px; cursor:pointer; text-decoration:none; display:inline-block; font-size:14px; }
    .btn[disabled], button.btn:disabled { opacity: .55; cursor: not-allowed; }
    .btn-primary { background: var(--brand-600); color:#fff; }
    .btn-secondary { background:#475569; color:#fff; }
    .btn-success { background:#059669; color:#fff; }
    .btn-warning { background:#d97706; color:#fff; }
    .btn-danger { background:#dc2626; color:#fff; }
    .grid { display:grid; gap:16px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; text-align:left; font-size:14px; }
    .form-row { margin-bottom:14px; min-width: 0; }
    .form-control, .form-select { width:100%; max-width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:6px; }
    .help { color:#64748b; font-size:12px; }
    .badge { display:inline-block; padding:3px 8px; border-radius:20px; font-size:12px; background:#e2e8f0; }

    /* Toast notifications (Django messages) */
    .toast-region {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 9999;
      width: min(420px, calc(100vw - 28px));
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: start;
      padding: 12px 12px 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(226, 232, 240, .9);
      background: rgba(255, 255, 255, .92);
      backdrop-filter: blur(8px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .12);
      transform: translateY(-6px);
      opacity: 0;
      animation: toast-in .18s ease-out forwards;
      position: relative;
      overflow: hidden;
    }
    .toast::before {
      content: "";
      position: absolute;
      inset: 0 auto 0 0;
      width: 6px;
      background: #64748b;
      opacity: .9;
    }
    .toast.success::before { background: #16a34a; }
    .toast.error::before { background: #dc2626; }
    .toast.warning::before { background: #d97706; }
    .toast.info::before { background: var(--brand-600); }

    .toast-body { font-size: 14px; color: #0f172a; line-height: 1.25rem; padding-left: 6px; }
    .toast-close {
      border: none;
      background: transparent;
      color: #334155;
      cursor: pointer;
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 16px;
      line-height: 16px;
      font-weight: 900;
    }
    .toast-close:hover { background: rgba(226, 232, 240, .7); }
    .toast.hide { animation: toast-out .18s ease-in forwards; }

    @keyframes toast-in {
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes toast-out {
      to { transform: translateY(-6px); opacity: 0; }
    }

    /* Confirm modal (replaces browser confirm()) */
    .confirm-overlay[hidden] { display: none !important; }
    .confirm-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(2, 6, 23, .55);
      display: grid;
      place-items: center;
      padding: 16px;
    }
    .confirm-dialog {
      width: min(520px, 100%);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(255,255,255,.96);
      box-shadow: 0 22px 60px rgba(2, 6, 23, .30);
      overflow: hidden;
      transform: translateY(6px);
      opacity: 0;
      animation: confirm-in .16s ease-out forwards;
    }
    .confirm-head {
      padding: 14px 16px 10px 16px;
      background: linear-gradient(180deg, rgba(15,23,42,.05), rgba(15,23,42,.00));
      border-bottom: 1px solid rgba(226,232,240,.9);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .confirm-title {
      margin: 0;
      font-size: 14px;
      font-weight: 900;
      color: #0f172a;
      letter-spacing: .02em;
    }
    .confirm-close {
      border: none;
      background: transparent;
      color: #0f172a;
      border-radius: 10px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 18px;
      line-height: 18px;
      font-weight: 900;
    }
    .confirm-close:hover { background: rgba(226,232,240,.85); }
    .confirm-body {
      padding: 14px 16px 6px 16px;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.3rem;
    }
    .confirm-actions {
      padding: 12px 16px 16px 16px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .confirm-actions .btn { font-weight: 900; }
    .confirm-actions .btn-secondary { background: #334155; }
    @keyframes confirm-in { to { transform: translateY(0); opacity: 1; } }

    /* SAF job overlay (progress) */
    .job-overlay[hidden] { display: none !important; }
    .job-overlay {
      position: fixed;
      inset: 0;
      z-index: 10001;
      background: rgba(2, 6, 23, .45);
      display: grid;
      place-items: center;
      padding: 16px;
    }
    .job-dialog {
      width: min(560px, 100%);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(255,255,255,.97);
      box-shadow: 0 22px 60px rgba(2, 6, 23, .30);
      overflow: hidden;
    }
    .job-head {
      padding: 14px 16px 10px 16px;
      background: linear-gradient(180deg, rgba(15,23,42,.05), rgba(15,23,42,.00));
      border-bottom: 1px solid rgba(226,232,240,.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .job-title { margin: 0; font-size: 14px; font-weight: 900; color:#0f172a; }
    .job-body { padding: 14px 16px 16px 16px; }
    .job-line { display:flex; gap:10px; align-items: baseline; justify-content: space-between; flex-wrap: wrap; }
    .job-status { color:#0f172a; font-weight: 800; }
    .job-meta { color:#64748b; font-size: 13px; }
    .job-bar {
      height: 12px;
      border-radius: 999px;
      background: #e2e8f0;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,.25);
      margin-top: 10px;
    }
    .job-bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(var(--brand-rgb), .95), rgba(var(--brand-rgb), .70));
      border-radius: 999px;
      transition: width .18s ease;
    }
    .job-msg { margin-top: 10px; color:#334155; font-size: 13px; white-space: pre-wrap; }
    .job-actions { margin-top: 14px; display:flex; gap:10px; justify-content: flex-end; flex-wrap: wrap; }

    /* Status + action chips (used across pages) */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid #e2e8f0;
      background: #f1f5f9;
      color: #334155;
      white-space: nowrap;
    }
    .status-badge[data-status="BORRADOR"] { background:#e0f2fe; border-color:#bae6fd; color:#075985; }
    .status-badge[data-status="EN_AUDITORIA"] { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .status-badge[data-status="OBSERVADO"] { background:#fef3c7; border-color:#fde68a; color:#92400e; }
    .status-badge[data-status="APROBADO"] { background:#dcfce7; border-color:#bbf7d0; color:#065f46; }
    .status-badge[data-status="POR_PUBLICAR"] { background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }
    .status-badge[data-status="PUBLICADO"] { background:#ecfeff; border-color:#a5f3fc; color:#155e75; }
    .status-badge[data-status="LISTO"] { background:#ede9fe; border-color:#ddd6fe; color:#5b21b6; }

    .action-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      color: #0f172a;
      white-space: nowrap;
    }
    .action-badge[data-action="send"], .action-badge[data-action="resubmit"] {
      background:#fff7ed; border-color:#fed7aa; color:#9a3412;
    }
    .action-badge[data-action="observe"] { background:#fef3c7; border-color:#fde68a; color:#92400e; }
    .action-badge[data-action="approve"] { background:#dcfce7; border-color:#bbf7d0; color:#065f46; }
    .action-badge[data-action="publish"] { background:#ecfeff; border-color:#a5f3fc; color:#155e75; }

    /* Auth page layout (login) */
    body.auth-page {
      background:
        radial-gradient(1200px 600px at 15% 20%, rgba(var(--brand-rgb), .16), transparent 60%),
        radial-gradient(900px 500px at 85% 30%, rgba(5, 150, 105, .14), transparent 55%),
        radial-gradient(700px 500px at 70% 90%, rgba(15, 23, 42, .10), transparent 60%),
        #f4f6f9;
    }
    body.auth-page .container { max-width:none; margin:0; padding:0; }

    /* App layout: header + sidebar + content */
    :root {
      /* Brand accent (higher contrast on dark UI) */
      --brand-600: #0f766e;
      --brand-500: #2dd4bf;
      --brand-rgb: 45, 212, 191;
      --header-h: 56px;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 72px;
      --shadow-1: 0 10px 28px rgba(2, 6, 23, .12);
      --shadow-2: 0 18px 55px rgba(2, 6, 23, .18);
    }

    .app-shell { min-height: 100vh; }
    .app-header {
      height: var(--header-h);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 14px;
      background: linear-gradient(180deg, rgba(10, 18, 33, .98), rgba(8, 12, 22, .96));
      color: #e2e8f0;
      border-bottom: 1px solid rgba(148,163,184,.20);
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      min-width: 0;
    }
    .brand span {
      font-weight: 900;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .header-spacer { flex: 1; }
    .icon-btn {
      border: 1px solid rgba(148, 163, 184, .30);
      background: rgba(2, 6, 23, .15);
      color: #e2e8f0;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .icon-btn:hover { background: rgba(2, 6, 23, .30); }
    .icon-btn:focus-visible { outline: 3px solid rgba(var(--brand-rgb), .55); outline-offset: 2px; }
    .icon-btn svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .uai-mark {
      width: 32px;
      height: 32px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      padding: 5px;
      border: 1px solid rgba(148,163,184,.18);
    }

    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .25);
      background: rgba(2, 6, 23, .12);
      color: rgba(226,232,240,.95);
      font-size: 13px;
      font-weight: 800;
      max-width: 340px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-pill svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .95;
    }

    .app-body {
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      min-height: calc(100vh - var(--header-h));
    }

    .sidebar-backdrop {
      position: fixed;
      inset: var(--header-h) 0 0 0;
      background: rgba(2, 6, 23, .55);
      z-index: 1100;
    }

    .sidebar {
      position: sticky;
      top: var(--header-h);
      height: calc(100vh - var(--header-h));
      background: linear-gradient(180deg, rgba(9, 15, 27, .99), rgba(5, 8, 14, .98));
      color: rgba(226,232,240,.92);
      border-right: 1px solid rgba(148,163,184,.18);
      overflow: hidden;
    }

    .sb-nav { padding: 12px 10px; display: flex; flex-direction: column; gap: 10px; }
    .sb-sec {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.07);
      overflow: hidden;
    }
    .sb-sec-btn {
      width: 100%;
      position: relative;
      display: grid;
      grid-template-columns: 22px 1fr 18px;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 11px;
    }
    .sb-sec-btn:hover { background: rgba(255,255,255,.08); }
    .sb-sec-btn:focus-visible { outline: 3px solid rgba(var(--brand-rgb), .55); outline-offset: -3px; }
    .sb-sec-btn svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; opacity: .95; }
    .sb-sec-btn[aria-expanded="true"] {
      background: rgba(255,255,255,.09);
      box-shadow: inset 4px 0 0 rgba(var(--brand-rgb), .70), inset 0 -1px 0 rgba(255,255,255,.08);
    }

    .sb-caret { width: 18px; height: 18px; display: inline-flex; align-items:center; justify-content:center; opacity: .80; }
    .sb-caret svg { width: 16px; height: 16px; }
    .sb-sec-btn[aria-expanded="true"] .sb-caret { transform: rotate(180deg); transition: transform .12s ease; }

    .sb-panel { padding: 6px 6px 10px 6px; }
    .sb-item {
      position: relative;
      display: grid;
      grid-template-columns: 22px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration: none;
      color: rgba(226,232,240,.92);
      font-weight: 800;
      font-size: 14px;
    }
    .sb-item:hover { background: rgba(255,255,255,.09); }
    .sb-item:focus-visible { outline: 3px solid rgba(var(--brand-rgb), .55); outline-offset: 2px; }
    .sb-item svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; opacity: .95; }

    .sb-item.is-active {
      color: #06261f;
      background: linear-gradient(180deg, rgba(var(--brand-rgb), .95), rgba(var(--brand-rgb), .78));
      border: 1px solid rgba(255,255,255,.35);
      box-shadow: 0 14px 28px rgba(2, 6, 23, .28);
    }
    .sb-item.is-active svg { opacity: 1; }

    .sb-footer {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px;
      border-top: 1px solid rgba(148,163,184,.18);
      background: linear-gradient(180deg, rgba(5, 8, 14, .40), rgba(5, 8, 14, .72));
      display: grid;
      gap: 10px;
    }
    .sb-user {
      display: grid;
      gap: 2px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .sb-user .u1 { font-weight: 900; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .sb-user .u2 { font-size: 12px; color: rgba(226,232,240,.72); }
    .sb-logout {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(226,232,240,.92);
      font-weight: 900;
    }
    .sb-logout:hover {
      background: rgba(255,255,255,.12);
      border-color: rgba(var(--brand-rgb), .55);
    }
    .sb-logout svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .app-content { min-width: 0; }
    .app-container { max-width: 1200px; margin: 18px auto; padding: 0 18px; }

    /* Collapse (desktop) */
    body.sidebar-collapsed .app-body { grid-template-columns: var(--sidebar-w-collapsed) 1fr; }
    body.sidebar-collapsed .sb-sec-btn { grid-template-columns: 22px 1fr; }
    body.sidebar-collapsed .sb-sec-btn .sb-caret { display: none; }
    body.sidebar-collapsed .sb-sec-btn .sb-label,
    body.sidebar-collapsed .sb-item .sb-label {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      clip-path: inset(50%);
      white-space: nowrap;
      border: 0;
    }
    body.sidebar-collapsed .sb-footer .sb-user { display: none; }
    body.sidebar-collapsed .sb-logout {
      justify-content: center;
      padding: 10px;
    }
    body.sidebar-collapsed .sb-logout span { display: none; }

    /* Flyout panels when collapsed */
    body.sidebar-collapsed .sb-panel[hidden] { display: none !important; }
    body.sidebar-collapsed .sb-panel {
      position: fixed;
      left: var(--sidebar-w-collapsed);
      top: var(--header-h);
      width: 260px;
      max-height: calc(100vh - var(--header-h) - 18px);
      overflow: auto;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.96);
      box-shadow: var(--shadow-2);
      z-index: 1200;
    }
    /* In collapsed mode, labels should be visible inside the flyout panel */
    body.sidebar-collapsed .sb-panel .sb-item .sb-label {
      position: static !important;
      width: auto;
      height: auto;
      margin: 0;
      overflow: visible;
      clip: auto;
      clip-path: none;
      white-space: nowrap;
    }

    @media (max-width: 920px) {
      .user-pill { display: none; }
      .desktop-only { display: none !important; }
      .app-body { grid-template-columns: 1fr; }
      .sidebar {
        position: fixed;
        top: var(--header-h);
        left: 0;
        height: calc(100vh - var(--header-h));
        width: var(--sidebar-w);
        transform: translateX(-105%);
        transition: transform .18s ease;
        z-index: 1200;
      }
      body.sidebar-open .sidebar { transform: translateX(0); }
      body.sidebar-open .sidebar-backdrop { display: block; }
      body.sidebar-collapsed .sb-panel { position: static; width: auto; box-shadow: none; }
      .app-container { margin: 16px auto; padding: 0 14px; }
    }

    @media (min-width: 921px) { .mobile-only { display: none !important; } }

    a:focus-visible { outline: 3px solid rgba(var(--brand-rgb), .55); outline-offset: 2px; border-radius: 10px; }
  </style>
</head>
<body class="{% block body_class %}{% endblock %}">
  {% if request.user.is_authenticated %}
  <div class="app-shell">
    <header class="app-header">
      <button class="icon-btn" id="btn-sidebar-toggle" type="button" aria-label="Menu" aria-expanded="false" aria-controls="app-sidebar">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>

      <a class="brand" href="{% url 'dashboard' %}">
        <span>Repositorio Tesis UAI</span>
      </a>

      <div class="header-spacer"></div>

      <div class="user-pill" title="{{ request.user.username }}">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 21a8 8 0 0 0-16 0"/><path d="M12 13a4 4 0 1 0-4-4 4 4 0 0 0 4 4"/></svg>
        <span>{{ request.user.username }}</span>
      </div>

      <img class="uai-mark" src="{% static 'logoUAI.png' %}" alt="UAI">
    </header>

    <div class="app-body">
      <div class="sidebar-backdrop" id="sidebar-backdrop" hidden></div>

      <aside class="sidebar" id="app-sidebar">
        <nav class="sb-nav" aria-label="Menu principal">

          <!-- Principal -->
          <div class="sb-sec" data-sec="principal">
            <button class="sb-sec-btn" type="button" title="Principal" aria-label="Principal" aria-controls="sidebar-sec-principal" {% if request.resolver_match.url_name == 'dashboard' %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}>
              <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/></svg></span>
              <span class="sb-label">Principal</span>
              <span class="sb-caret" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></span>
            </button>
            <div class="sb-panel" id="sidebar-sec-principal" {% if request.resolver_match.url_name != 'dashboard' %}hidden{% endif %}>
              <a class="sb-item {% if request.resolver_match.url_name == 'dashboard' %}is-active{% endif %}" title="Dashboard" href="{% url 'dashboard' %}" {% if request.resolver_match.url_name == 'dashboard' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 13h6v7H4z"/><path d="M14 3h6v17h-6z"/><path d="M4 3h6v7H4z"/></svg></span>
                <span class="sb-label">Dashboard</span>
              </a>
            </div>
          </div>

          <!-- Gestion -->
          <div class="sb-sec" data-sec="gestion">
            <button class="sb-sec-btn" type="button" title="Gestion" aria-label="Gestion" aria-controls="sidebar-sec-gestion" {% if request.resolver_match.namespace == 'registry' or request.resolver_match.namespace == 'saf' %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}>
              <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg></span>
              <span class="sb-label">Gestion</span>
              <span class="sb-caret" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></span>
            </button>
            <div class="sb-panel" id="sidebar-sec-gestion" {% if request.resolver_match.namespace != 'registry' and request.resolver_match.namespace != 'saf' %}hidden{% endif %}>
              <a class="sb-item {% if request.resolver_match.namespace == 'registry' and request.resolver_match.url_name|slice:':7' == 'groups_' %}is-active{% endif %}" title="Sustentaciones" href="{% url 'registry:groups_list' %}" {% if request.resolver_match.namespace == 'registry' and request.resolver_match.url_name|slice:':7' == 'groups_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 3h10v4H7z"/><path d="M5 7h14v14H5z"/><path d="M8 11h8"/><path d="M8 15h8"/></svg></span>
                <span class="sb-label">Sustentaciones</span>
              </a>
              {% if request.user.role == 'auditor' %}
                <a class="sb-item {% if request.resolver_match.namespace == 'saf' %}is-active{% endif %}" title="Publicación SAF" href="{% url 'saf:batches_list' %}" {% if request.resolver_match.namespace == 'saf' %}aria-current="page"{% endif %}>
                  <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 3l9 4-9 4-9-4z"/><path d="M3 7v10l9 4 9-4V7"/></svg></span>
                  <span class="sb-label">Publicación SAF</span>
                </a>
              {% endif %}
            </div>
          </div>

          <!-- Catalogos -->
          <div class="sb-sec" data-sec="catalogos">
            <button class="sb-sec-btn" type="button" title="Catalogos" aria-label="Catalogos" aria-controls="sidebar-sec-catalogos"
              {% if request.resolver_match.namespace == 'appconfig' %}
                {% if request.resolver_match.url_name|slice:':9' == 'advisors_' or request.resolver_match.url_name|slice:':7' == 'jurors_' %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}
              {% else %}
                aria-expanded="false"
              {% endif %}>
              <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4"/><path d="M4 21a8 8 0 0 1 16 0"/></svg></span>
              <span class="sb-label">Catalogos</span>
              <span class="sb-caret" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></span>
            </button>
            <div class="sb-panel" id="sidebar-sec-catalogos"
              {% if request.resolver_match.namespace == 'appconfig' %}
                {% if request.resolver_match.url_name|slice:':9' == 'advisors_' or request.resolver_match.url_name|slice:':7' == 'jurors_' %}{% else %}hidden{% endif %}
              {% else %}
                hidden
              {% endif %}>
              <a class="sb-item {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':9' == 'advisors_' %}is-active{% endif %}" title="Asesores" href="{% url 'appconfig:advisors_list' %}" {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':9' == 'advisors_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4"/><path d="M2 21a10 10 0 0 1 20 0"/></svg></span>
                <span class="sb-label">Asesores</span>
              </a>
              <a class="sb-item {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':7' == 'jurors_' %}is-active{% endif %}" title="Jurados" href="{% url 'appconfig:jurors_list' %}" {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':7' == 'jurors_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 7h10"/><path d="M7 12h10"/><path d="M7 17h10"/><path d="M5 4h14v16H5z"/></svg></span>
                <span class="sb-label">Jurados</span>
              </a>
            </div>
          </div>

          {% if request.user.role == 'auditor' %}
          <!-- Configuracion -->
          <div class="sb-sec" data-sec="configuracion">
            <button class="sb-sec-btn" type="button" title="Configuracion" aria-label="Configuracion" aria-controls="sidebar-sec-configuracion"
              {% if request.resolver_match.namespace == 'appconfig' %}
                {% if request.resolver_match.url_name|slice:':8' == 'careers_' or request.resolver_match.url_name|slice:':9' == 'licenses_' or request.resolver_match.url_name|slice:':7' == 'params_' %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}
              {% else %}
                aria-expanded="false"
              {% endif %}>
              <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 1v4"/><path d="M12 19v4"/><path d="M4.2 4.2l2.8 2.8"/><path d="M17 17l2.8 2.8"/><path d="M1 12h4"/><path d="M19 12h4"/><path d="M4.2 19.8L7 17"/><path d="M17 7l2.8-2.8"/><path d="M12 8a4 4 0 1 0 4 4 4 4 0 0 0-4-4"/></svg></span>
              <span class="sb-label">Configuracion</span>
              <span class="sb-caret" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></span>
            </button>
            <div class="sb-panel" id="sidebar-sec-configuracion"
              {% if request.resolver_match.namespace == 'appconfig' %}
                {% if request.resolver_match.url_name|slice:':8' == 'careers_' or request.resolver_match.url_name|slice:':9' == 'licenses_' or request.resolver_match.url_name|slice:':7' == 'params_' %}{% else %}hidden{% endif %}
              {% else %}
                hidden
              {% endif %}>
              <a class="sb-item {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':8' == 'careers_' %}is-active{% endif %}" title="Carreras" href="{% url 'appconfig:careers_list' %}" {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':8' == 'careers_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M3 7l9-4 9 4-9 4z"/><path d="M3 7v10l9 4 9-4V7"/></svg></span>
                <span class="sb-label">Carreras</span>
              </a>
              <a class="sb-item {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':9' == 'licenses_' %}is-active{% endif %}" title="Licencias" href="{% url 'appconfig:licenses_list' %}" {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':9' == 'licenses_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 4h10v16H7z"/><path d="M9 8h6"/><path d="M9 12h6"/></svg></span>
                <span class="sb-label">Licencias</span>
              </a>
              <a class="sb-item {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':7' == 'params_' %}is-active{% endif %}" title="Parametros" href="{% url 'appconfig:params_list' %}" {% if request.resolver_match.namespace == 'appconfig' and request.resolver_match.url_name|slice:':7' == 'params_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 3v18"/><path d="M3 12h18"/><path d="M5 5l14 14"/><path d="M19 5 5 19"/></svg></span>
                <span class="sb-label">Parametros</span>
              </a>
            </div>
          </div>

          <!-- Administracion -->
          <div class="sb-sec" data-sec="administracion">
            <button class="sb-sec-btn" type="button" title="Administracion" aria-label="Administracion" aria-controls="sidebar-sec-administracion" {% if request.resolver_match.namespace == 'accounts' and request.resolver_match.url_name|slice:':6' == 'users_' %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}>
              <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4"/><path d="M4 21a8 8 0 0 1 16 0"/></svg></span>
              <span class="sb-label">Administracion</span>
              <span class="sb-caret" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></span>
            </button>
            <div class="sb-panel" id="sidebar-sec-administracion" {% if request.resolver_match.namespace == 'accounts' and request.resolver_match.url_name|slice:':6' == 'users_' %}{% else %}hidden{% endif %}>
              <a class="sb-item {% if request.resolver_match.namespace == 'accounts' and request.resolver_match.url_name|slice:':6' == 'users_' %}is-active{% endif %}" title="Usuarios" href="{% url 'accounts:users_list' %}" {% if request.resolver_match.namespace == 'accounts' and request.resolver_match.url_name|slice:':6' == 'users_' %}aria-current="page"{% endif %}>
                <span class="sb-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M9 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
                <span class="sb-label">Usuarios</span>
              </a>
            </div>
          </div>
          {% endif %}

        </nav>

        <div class="sb-footer">
          <a class="sb-logout" title="Salir" href="{% url 'accounts:logout' %}">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17l5-5-5-5"/><path d="M15 12H3"/><path d="M21 3v18"/></svg>
            <span>Salir</span>
          </a>
        </div>
      </aside>

      <main class="app-content" id="app-content" tabindex="-1">
        <div class="app-container">
  {% else %}
  <div class="container {% block container_class %}{% endblock %}">
  {% endif %}

    {% if messages %}
      <div class="toast-region" id="toast-region" aria-live="polite" aria-atomic="true">
        {% for message in messages %}
          <div class="toast {{ message.tags }}" role="alert">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="toast-close" aria-label="Cerrar" title="Cerrar">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}

  {% if request.user.is_authenticated %}
        </div>
      </main>
    </div>
  </div>
  {% else %}
  </div>
  {% endif %}

  <div class="confirm-overlay" id="confirm-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-message">
    <div class="confirm-dialog">
      <div class="confirm-head">
        <h3 class="confirm-title" id="confirm-title">Confirmar</h3>
        <button type="button" class="confirm-close" id="confirm-close" aria-label="Cerrar" title="Cerrar">×</button>
      </div>
      <div class="confirm-body" id="confirm-message"></div>
      <div class="confirm-actions">
        <button type="button" class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirm-ok">Aceptar</button>
      </div>
    </div>
  </div>

  <div class="job-overlay" id="job-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="job-title">
    <div class="job-dialog">
      <div class="job-head">
        <h3 class="job-title" id="job-title">Generando SAF</h3>
        <button type="button" class="confirm-close" id="job-close" aria-label="Cerrar" title="Cerrar">×</button>
      </div>
      <div class="job-body">
        <div class="job-line">
          <div class="job-status" id="job-status">Iniciando...</div>
          <div class="job-meta" id="job-meta">0%</div>
        </div>
        <div class="job-bar"><div id="job-bar-fill"></div></div>
        <div class="job-msg" id="job-msg"></div>
        <div class="job-actions">
          <button type="button" class="btn btn-secondary" id="job-reload" hidden>Actualizar</button>
          <button type="button" class="btn btn-secondary" id="job-hide">Ocultar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      function autoHideMs(toast) {
        if (toast.classList.contains('error')) return 10000;
        if (toast.classList.contains('warning')) return 8000;
        return 5500;
      }

      function hideToast(toast) {
        if (!toast || toast.classList.contains('hide')) return;
        toast.classList.add('hide');
        window.setTimeout(function () {
          if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
          var region = document.getElementById('toast-region');
          if (region && region.children.length === 0 && region.parentNode) region.parentNode.removeChild(region);
        }, 220);
      }

      document.addEventListener('click', function (ev) {
        var btn = ev.target && ev.target.closest ? ev.target.closest('.toast-close') : null;
        if (!btn) return;
        var toast = btn.closest('.toast');
        hideToast(toast);
      });

      function initAutoHide() {
        var region = document.getElementById('toast-region');
        if (!region) return;
        Array.prototype.forEach.call(region.querySelectorAll('.toast'), function (t) {
          window.setTimeout(function () { hideToast(t); }, autoHideMs(t));
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAutoHide);
      } else {
        initAutoHide();
      }
    })();

    (function () {
      // Replace browser confirm() with a consistent modal.
      var overlay = document.getElementById('confirm-overlay');
      if (!overlay) return;
      var btnOk = document.getElementById('confirm-ok');
      var btnCancel = document.getElementById('confirm-cancel');
      var btnClose = document.getElementById('confirm-close');
      var elTitle = document.getElementById('confirm-title');
      var elMsg = document.getElementById('confirm-message');

      var pending = null; // { type: 'form'|'link'|'button', ... }

      function isVisible() { return !overlay.hidden; }

      function closeModal() {
        overlay.hidden = true;
        pending = null;
      }

      function openModal(opts) {
        pending = opts || null;
        elTitle.textContent = (opts && opts.title) ? opts.title : 'Confirmar';
        elMsg.textContent = (opts && opts.message) ? opts.message : '¿Confirmas la acción?';
        overlay.hidden = false;
        // Focus OK by default to keep flow fast
        window.setTimeout(function () { if (btnOk && btnOk.focus) btnOk.focus(); }, 0);
      }

      function onConfirm() {
        var p = pending;
        closeModal();
        if (!p) return;
        if (p.type === 'link' && p.href) {
          window.location.href = p.href;
          return;
        }
        if (p.type === 'form' && p.form) {
          // requestSubmit keeps HTML5 validation behavior if any.
          if (p.submitter && p.form.requestSubmit) p.form.requestSubmit(p.submitter);
          else if (p.form.requestSubmit) p.form.requestSubmit();
          else p.form.submit();
          return;
        }
        if (p.type === 'button' && p.button) {
          p.button.click();
        }
      }

      function onCancel() { closeModal(); }

      document.addEventListener('keydown', function (ev) {
        if (!isVisible()) return;
        if (ev.key === 'Escape') { ev.preventDefault(); closeModal(); }
      });

      overlay.addEventListener('click', function (ev) {
        // Click outside dialog closes
        if (ev.target === overlay) closeModal();
      });
      if (btnCancel) btnCancel.addEventListener('click', onCancel);
      if (btnClose) btnClose.addEventListener('click', onCancel);
      if (btnOk) btnOk.addEventListener('click', onConfirm);

      document.addEventListener('click', function (ev) {
        var el = ev.target && ev.target.closest ? ev.target.closest('[data-confirm]') : null;
        if (!el) return;
        var msg = (el.getAttribute('data-confirm') || '').trim();
        if (!msg) return;
        var title = (el.getAttribute('data-confirm-title') || '').trim();

        // Avoid double-triggering when another handler already prevented.
        ev.preventDefault();

        // If anchor: navigate after confirm
        if (el.tagName === 'A') {
          openModal({ type: 'link', href: el.getAttribute('href'), title: title || 'Confirmar', message: msg });
          return;
        }

        // If inside form: submit after confirm
        var form = el.closest ? el.closest('form') : null;
        if (form) {
          openModal({ type: 'form', form: form, submitter: el, title: title || 'Confirmar', message: msg });
          return;
        }

        openModal({ type: 'button', button: el, title: title || 'Confirmar', message: msg });
      });
    })();

    (function () {
      // SAF progress overlay for forms with class .js-saf-generate
      var overlay = document.getElementById('job-overlay');
      if (!overlay) return;
      var elTitle = document.getElementById('job-title');
      var elStatus = document.getElementById('job-status');
      var elMeta = document.getElementById('job-meta');
      var elMsg = document.getElementById('job-msg');
      var barFill = document.getElementById('job-bar-fill');
      var btnHide = document.getElementById('job-hide');
      var btnClose = document.getElementById('job-close');
      var btnReload = document.getElementById('job-reload');

      var pollTimer = null;
      var currentProgressUrl = null;

      function setVisible(v) { overlay.hidden = !v; }
      function isVisible() { return !overlay.hidden; }

      function setBar(pct) {
        var p = Math.max(0, Math.min(100, Number(pct || 0)));
        if (barFill) barFill.style.width = p + '%';
        if (elMeta) elMeta.textContent = p + '%';
      }

      function setText(status, msg) {
        if (elStatus) elStatus.textContent = status || '';
        if (elMsg) elMsg.textContent = msg || '';
      }

      function stopPolling() {
        if (pollTimer) window.clearInterval(pollTimer);
        pollTimer = null;
        currentProgressUrl = null;
      }

      function startPolling(progressUrl) {
        currentProgressUrl = progressUrl;
        if (!progressUrl) return;
        if (pollTimer) window.clearInterval(pollTimer);
        pollTimer = window.setInterval(function () {
          fetch(progressUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (j) {
              if (!j || !j.ok) return;
              var total = j.total || 0;
              var done = j.done || 0;
              var pct = (typeof j.percent === 'number') ? j.percent : (total ? Math.floor(done * 100 / total) : 0);
              setBar(pct);

              var label = 'En proceso';
              if (j.status === 'RUNNING') label = 'Generando SAF...';
              if (j.status === 'DONE') label = 'Completado';
              if (j.status === 'FAILED') label = 'Fallido';
              setText(label, j.message || ('Procesados: ' + done + '/' + total));

              if (j.status === 'DONE') {
                setBar(100);
                stopPolling();
                // Reload to show ZIP buttons/status in UI
                window.setTimeout(function () { window.location.reload(); }, 650);
              } else if (j.status === 'FAILED') {
                stopPolling();
                if (btnReload) btnReload.hidden = false;
              }
            })
            .catch(function () { /* ignore */ });
        }, 900);
      }

      function openJob(title) {
        if (elTitle) elTitle.textContent = title || 'Procesando';
        if (btnReload) btnReload.hidden = true;
        setBar(0);
        setText('Iniciando...', '');
        setVisible(true);
      }

      function hideJob() { setVisible(false); }

      if (btnHide) btnHide.addEventListener('click', function () { hideJob(); });
      if (btnClose) btnClose.addEventListener('click', function () { stopPolling(); hideJob(); });
      if (btnReload) btnReload.addEventListener('click', function () { window.location.reload(); });
      overlay.addEventListener('click', function (ev) { if (ev.target === overlay) hideJob(); });
      document.addEventListener('keydown', function (ev) { if (ev.key === 'Escape' && isVisible()) hideJob(); });

      document.addEventListener('submit', function (ev) {
        var form = ev.target;
        if (!form || !form.classList || !form.classList.contains('js-saf-generate')) return;
        ev.preventDefault();

        var progressUrl = form.getAttribute('data-progress-url') || '';
        openJob('Generando SAF');

        fetch(form.getAttribute('action'), {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
          body: new FormData(form)
        })
          .then(function (r) { return r.json().then(function (j) { return { r: r, j: j }; }); })
          .then(function (out) {
            var r = out.r, j = out.j;
            if (!r.ok || !j || !j.ok) {
              setText('No se pudo iniciar', (j && j.message) ? j.message : 'Error iniciando el proceso.');
              if (btnReload) btnReload.hidden = false;
              return;
            }
            startPolling(progressUrl);
          })
          .catch(function () {
            setText('Error', 'No se pudo conectar con el servidor.');
            if (btnReload) btnReload.hidden = false;
          });
      });
    })();

    (function () {
      var sidebar = document.getElementById('app-sidebar');
      if (!sidebar) return;

      var backdrop = document.getElementById('sidebar-backdrop');
      var btnToggle = document.getElementById('btn-sidebar-toggle');

      function isMobile() {
        return window.matchMedia && window.matchMedia('(max-width: 920px)').matches;
      }

      function setBackdrop(open) {
        if (!backdrop) return;
        backdrop.hidden = !open;
      }

      function setMobileOpen(open) {
        document.body.classList.toggle('sidebar-open', !!open);
        if (btnToggle) btnToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        setBackdrop(open);

        if (open) {
          window.setTimeout(function () {
            var first = sidebar.querySelector('a.sb-item, a.sb-logout, button.sb-sec-btn');
            if (first && first.focus) first.focus();
          }, 0);
        } else {
          if (btnToggle && btnToggle.focus) btnToggle.focus();
        }
      }

      function setCollapsed(collapsed) {
        document.body.classList.toggle('sidebar-collapsed', !!collapsed);
        if (btnToggle) btnToggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
        try { localStorage.setItem('uai_sidebar_collapsed', collapsed ? '1' : '0'); } catch (e) {}
      }

      function closeAllSections(exceptId) {
        Array.prototype.forEach.call(sidebar.querySelectorAll('.sb-sec'), function (sec) {
          var btn = sec.querySelector('.sb-sec-btn');
          var panel = sec.querySelector('.sb-panel');
          if (!btn || !panel) return;
          var secId = sec.getAttribute('data-sec') || '';
          if (exceptId && secId === exceptId) return;
          btn.setAttribute('aria-expanded', 'false');
          panel.hidden = true;
        });
      }

      function openSection(secId) {
        if (!secId) return;
        var sec = sidebar.querySelector('.sb-sec[data-sec=\"' + secId + '\"]');
        if (!sec) return;
        var btn = sec.querySelector('.sb-sec-btn');
        var panel = sec.querySelector('.sb-panel');
        if (!btn || !panel) return;
        closeAllSections(secId);
        btn.setAttribute('aria-expanded', 'true');
        panel.hidden = false;
        try { sessionStorage.setItem('uai_sidebar_open_section', secId); } catch (e) {}
      }

      function toggleSection(secId) {
        var sec = sidebar.querySelector('.sb-sec[data-sec=\"' + secId + '\"]');
        if (!sec) return;
        var btn = sec.querySelector('.sb-sec-btn');
        var panel = sec.querySelector('.sb-panel');
        if (!btn || !panel) return;

        var isOpen = btn.getAttribute('aria-expanded') === 'true' && !panel.hidden;
        if (isOpen) {
          btn.setAttribute('aria-expanded', 'false');
          panel.hidden = true;
          try { sessionStorage.removeItem('uai_sidebar_open_section'); } catch (e) {}
          return;
        }
        openSection(secId);
      }

      (function initCollapsed() {
        var collapsed = false;
        try { collapsed = localStorage.getItem('uai_sidebar_collapsed') === '1'; } catch (e) {}
        setCollapsed(collapsed);
      })();

      (function initOpenSection() {
        // When the sidebar is collapsed on desktop, keep flyouts closed by default.
        // Otherwise the active item forces a panel to stay open and it feels "stuck".
        if (document.body.classList.contains('sidebar-collapsed') && !isMobile()) {
          closeAllSections();
          try { sessionStorage.removeItem('uai_sidebar_open_section'); } catch (e) {}
          return;
        }

        var activeItem = sidebar.querySelector('.sb-item.is-active');
        if (activeItem) {
          var s1 = activeItem.closest ? activeItem.closest('.sb-sec') : null;
          if (s1) {
            openSection(s1.getAttribute('data-sec'));
            return;
          }
        }
        var saved = null;
        try { saved = sessionStorage.getItem('uai_sidebar_open_section'); } catch (e) {}
        if (saved) {
          openSection(saved);
          return;
        }
        var already = sidebar.querySelector('.sb-sec-btn[aria-expanded=\"true\"]');
        var s2 = already && already.closest ? already.closest('.sb-sec') : null;
        if (s2) openSection(s2.getAttribute('data-sec'));
      })();

      sidebar.addEventListener('click', function (ev) {
        var btn = ev.target && ev.target.closest ? ev.target.closest('.sb-sec-btn') : null;
        if (btn) {
          var sec = btn.closest ? btn.closest('.sb-sec') : null;
          if (!sec) return;
          ev.preventDefault();
          toggleSection(sec.getAttribute('data-sec'));
          return;
        }

        var link = ev.target && ev.target.closest ? ev.target.closest('a') : null;
        if (!link) return;
        if (isMobile()) {
          setMobileOpen(false);
          return;
        }
        if (document.body.classList.contains('sidebar-collapsed')) {
          closeAllSections();
          try { sessionStorage.removeItem('uai_sidebar_open_section'); } catch (e) {}
        }
      });

      if (btnToggle) {
        btnToggle.addEventListener('click', function () {
          if (isMobile()) {
            setMobileOpen(!document.body.classList.contains('sidebar-open'));
            return;
          }
          setCollapsed(!document.body.classList.contains('sidebar-collapsed'));
          closeAllSections();
          try { sessionStorage.removeItem('uai_sidebar_open_section'); } catch (e) {}
        });
      }

      if (backdrop) backdrop.addEventListener('click', function () { setMobileOpen(false); });

      document.addEventListener('keydown', function (ev) {
        if (ev.key !== 'Escape') return;
        if (document.body.classList.contains('sidebar-open')) setMobileOpen(false);
      });

      document.addEventListener('click', function (ev) {
        if (!document.body.classList.contains('sidebar-collapsed')) return;
        if (isMobile()) return;
        if (ev.target && ev.target.closest && ev.target.closest('#app-sidebar')) return;
        closeAllSections();
      });
    })();
  </script>
</body>
</html>
